<!-- vibeapp/public/templates/social.html -->
{% extends "layout.html" %}
{% block title %}
    ì†Œì…œ í—ˆë¸Œ | CrossVibe
{% endblock title %}
{% block content %}
    <div class="container mt-4">
        <!-- í—¤ë” -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>ğŸ‘¥ ì†Œì…œ í—ˆë¸Œ</h2>
            <a href="{{ url_for('public.home') }}" class="btn btn-outline-secondary">â† í™ˆìœ¼ë¡œ</a>
        </div>
        <!-- ì‚¬ìš©ìëª… í™•ì¸ -->
        {% if not user.username %}
            <div class="alert alert-warning">
                <h5>âš ï¸ ì‚¬ìš©ìëª…ì´ í•„ìš”í•©ë‹ˆë‹¤</h5>
                <p>ì†Œì…œ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¨¼ì € ì‚¬ìš©ìëª…ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.</p>
                <a href="{{ url_for('public.set_username_page') }}"
                   class="btn btn-primary">ğŸ¯ ì‚¬ìš©ìëª… ì„¤ì •í•˜ê¸°</a>
            </div>
        {% else %}
            <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
            <ul class="nav nav-tabs mb-4" id="socialTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active"
                            id="friends-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#friends"
                            type="button"
                            role="tab">ğŸ‘« ë‚´ ì¹œêµ¬ ({{ friends|length }})</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link position-relative"
                            id="manage-friends-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#manage-friends"
                            type="button"
                            role="tab">
                        â• ì¹œêµ¬ ê´€ë¦¬
                        {% if pending_requests_count > 0 %}
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                {{ pending_requests_count }}
                            </span>
                        {% endif %}
                    </button>
                </li>
            </ul>
            <!-- íƒ­ ì»¨í…ì¸  -->
            <div class="tab-content" id="socialTabsContent">
                <!-- ë‚´ ì¹œêµ¬ íƒ­ -->
                <div class="tab-pane fade show active" id="friends" role="tabpanel">
                    {% if friends %}
                        <div class="row">
                            {% for friend in friends %}
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 class="card-title mb-1">{{ friend.display_name or friend.username }}</h6>
                                                    <small class="text-muted">
                                                        {% if friend.platform_connections %}
                                                            {% for conn in friend.platform_connections %}
                                                                {% if conn.platform == "spotify" %}ğŸµ Spotify{% endif %}
                                                                {% if conn.platform == "youtube" %}â–¶ï¸ YouTube{% endif %}
                                                                {% if not loop.last %},{% endif %}
                                                            {% endfor %}
                                                        {% else %}
                                                            ì—°ê²°ëœ í”Œë«í¼ ì—†ìŒ
                                                        {% endif %}
                                                    </small>
                                                </div>
                                                <div>
                                                    <button class="btn btn-primary btn-sm"
                                                            onclick="viewFriendProfile('{{ friend.username }}')">
                                                        ğŸ‘¤ í”„ë¡œí•„
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <!-- ì¹œêµ¬ í†µê³„ -->
                        <div class="mt-4 p-3 bg-light rounded">
                            <h6>ğŸ“Š ì¹œêµ¬ í†µê³„</h6>
                            <p class="mb-0">ì´ {{ friends|length }}ëª…ì˜ ì¹œêµ¬ì™€ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤!</p>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <div class="display-1">ğŸ‘¥</div>
                            <h4>ì•„ì§ ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤</h4>
                            <p class="text-muted">ì¹œêµ¬ë¥¼ ì¶”ê°€í•´ì„œ ìŒì•… ì·¨í–¥ì„ ê³µìœ í•´ë³´ì„¸ìš”!</p>
                            <button class="btn btn-primary"
                                    onclick="document.getElementById('manage-friends-tab').click()">ì¹œêµ¬ ì¶”ê°€í•˜ê¸°</button>
                        </div>
                    {% endif %}
                </div>
                <!-- ì¹œêµ¬ ê´€ë¦¬ íƒ­ -->
                <div class="tab-pane fade" id="manage-friends" role="tabpanel">
                    <!-- ìƒˆ ì¹œêµ¬ ì°¾ê¸° ì„¹ì…˜ (ìƒë‹¨ ì „ì²´ í­) -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">ğŸ” ìƒˆ ì¹œêµ¬ ì°¾ê¸°</h5>
                                </div>
                                <div class="card-body">
                                    <div class="input-group mb-3">
                                        <input type="text"
                                               class="form-control"
                                               id="friendUsername"
                                               placeholder="ì¹œêµ¬ì˜ ì‚¬ìš©ìëª…ì„ ê²€ìƒ‰í•˜ì„¸ìš”"
                                               maxlength="20"
                                               autocomplete="off">
                                        <button class="btn btn-outline-secondary"
                                                type="button"
                                                onclick="clearSearch()">ğŸ—‘ï¸ ì§€ìš°ê¸°</button>
                                    </div>
                                    <!-- ê²€ìƒ‰ ê²°ê³¼ ì˜ì—­ -->
                                    <div id="searchResults" class="mb-3 search-result">
                                        <div class="border rounded p-2 bg-light">
                                            <h6 class="mb-2">ğŸ” ê²€ìƒ‰ ê²°ê³¼</h6>
                                            <div id="searchResultsList">
                                                <!-- ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨-->
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="alert alert-info mb-0">
                                                <small>
                                                    <strong>ğŸ’¡ íŒ:</strong> ì‚¬ìš©ìëª…ì„ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ê²€ìƒ‰ë©ë‹ˆë‹¤.
                                                </small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="bg-light p-3 rounded">
                                                {% if user.username %}
                                                    <strong>ë‚´ ì‚¬ìš©ìëª…:</strong>
                                                    <code>{{ user.username }}</code>
                                                    <br>
                                                    <small class="text-muted">ì¹œêµ¬ë“¤ì—ê²Œ ì•Œë ¤ì£¼ì„¸ìš”!</small>
                                                {% else %}
                                                    <strong>ë‚´ ì‚¬ìš©ìëª…:</strong>
                                                    <span class="text-warning">ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤</span>
                                                    <br>
                                                    <small class="text-muted">
                                                        <a href="{{ url_for('public.set_username_page') }}"
                                                           class="text-primary">ì‚¬ìš©ìëª…ì„ ì„¤ì •í•´ì£¼ì„¸ìš”</a>
                                                    </small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- ë°›ì€ ì‹ ì²­ & ë³´ë‚¸ ì‹ ì²­ ì„¹ì…˜ (í•˜ë‹¨ ë‚˜ë€íˆ) -->
                    <div class="row">
                        <!-- ë°›ì€ ì‹ ì²­ ì„¹ì…˜ -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">ğŸ“¨ ë°›ì€ ì‹ ì²­</h5>
                                    {% if pending_requests_count > 0 %}
                                        <span class="badge bg-light text-dark">{{ pending_requests_count }}</span>
                                    {% endif %}
                                </div>
                                <div class="card-body scrollable-card-body">
                                    {% if pending_requests %}
                                        {% for req in pending_requests %}
                                            <div class="d-flex justify-content-between align-items-center mb-3 p-2 border rounded">
                                                <div>
                                                    <h6 class="mb-0">{{ req.requester.display_name or req.requester.username }}</h6>
                                                    <small class="text-muted">{{ req.created_at|kst }}</small>
                                                </div>
                                                <div>
                                                    <button class="btn btn-success btn-sm me-1"
                                                            onclick="respondToRequest({{ req.id }}, 'accept')">
                                                        âœ…
                                                    </button>
                                                    <button class="btn btn-danger btn-sm"
                                                            onclick="respondToRequest({{ req.id }}, 'reject')">
                                                        âŒ
                                                    </button>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-center text-muted py-3">
                                            <div class="mb-2">ğŸ“­</div>
                                            <small>ë°›ì€ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤</small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <!-- ë³´ë‚¸ ì‹ ì²­ í˜„í™© ì„¹ì…˜ -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-warning text-dark">
                                    <h5 class="mb-0">ğŸ“¤ ë³´ë‚¸ ì‹ ì²­ í˜„í™©</h5>
                                </div>
                                <div class="card-body scrollable-card-body">
                                    {% if sent_requests %}
                                        {% for req in sent_requests %}
                                            <div class="d-flex justify-content-between align-items-center mb-3 p-2 border rounded">
                                                <div>
                                                    <h6 class="mb-0">{{ req.receiver.display_name or req.receiver.username }}</h6>
                                                    <small class="text-muted">{{ req.created_at|kst }}ì— ì „ì†¡</small>
                                                </div>
                                                <div>
                                                    {% if req.status == "pending" %}
                                                        <span class="badge bg-warning me-1">â³</span>
                                                        <button class="btn btn-danger btn-sm" onclick="cancelRequest({{ req.id }})">ì·¨ì†Œ</button>
                                                    {% elif req.status == "accepted" %}
                                                        <span class="badge bg-success">âœ…</span>
                                                    {% elif req.status == "rejected" %}
                                                        <span class="badge bg-danger">âŒ</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endfor %}
                                        <!-- ì‹ ì²­ í˜„í™© í†µê³„ -->
                                        {% set pending_count = sent_requests | selectattr("status", "equalto", "pending") | list | length %}
                                        {% set accepted_count = sent_requests | selectattr("status", "equalto", "accepted") | list | length %}
                                        {% set rejected_count = sent_requests | selectattr("status", "equalto", "rejected") | list | length %}
                                        <div class="mt-3 p-2 bg-light rounded">
                                            <small class="fw-bold">ğŸ“Š í˜„í™©:</small>
                                            <div class="d-flex justify-content-between mt-2">
                                                <span class="badge bg-warning">â³ {{ pending_count }}</span>
                                                <span class="badge bg-success">âœ… {{ accepted_count }}</span>
                                                <span class="badge bg-danger">âŒ {{ rejected_count }}</span>
                                            </div>
                                        </div>
                                    {% else %}
                                        <div class="text-center py-4 text-muted">
                                            <div class="display-4">ğŸ“¤</div>
                                            <h6>ë³´ë‚¸ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤</h6>
                                            <small>ìƒˆë¡œìš´ ì¹œêµ¬ë“¤ì—ê²Œ ì‹ ì²­ì„ ë³´ë‚´ë³´ì„¸ìš”!</small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
    <script>
        // ê¸°ì¡´ social.htmlì˜ í•¨ìˆ˜ë“¤ (search.jsì™€ í†µí•©ë˜ì§€ ì•Šì€ ë¶€ë¶„)
        
        // ì¹œêµ¬ ì‹ ì²­ ì‘ë‹µ (ê¸°ì¡´ ë°›ì€ ì‹ ì²­ ì˜ì—­ìš©)
        async function respondToRequest(requestId, action) {
            const actionText = action === 'accept' ? 'ìˆ˜ë½' : 'ê±°ì ˆ';
            
            if (!confirm(`ì •ë§ë¡œ ì´ ì¹œêµ¬ ì‹ ì²­ì„ ${actionText}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            try {
                const response = await fetch(`/respond-friend-request/${requestId}/${action}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert('ì˜¤ë¥˜: ' + result.error);
                }
            } catch (error) {
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì¹œêµ¬ ì‹ ì²­ ì·¨ì†Œ
        async function cancelRequest(requestId) {
            if (!confirm('ì •ë§ë¡œ ì´ ì¹œêµ¬ ì‹ ì²­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                const response = await fetch(`/cancel-friend-request/${requestId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert('ì˜¤ë¥˜: ' + result.error);
                }
            } catch (error) {
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì¹œêµ¬ í”„ë¡œí•„ ë³´ê¸° (í–¥í›„ êµ¬í˜„)
        function viewFriendProfile(username) {
            if (username) {
                window.location.href = `/user/${username}`;
            } else {
                alert('ì¹œêµ¬ í”„ë¡œí•„ ë³´ê¸° ê¸°ëŠ¥ì€ ê³§ êµ¬í˜„ë  ì˜ˆì •ì…ë‹ˆë‹¤!');
            }
        }
    </script>
{% endblock content %}
