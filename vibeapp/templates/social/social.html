<!-- vibeapp/public/templates/social.html -->
{% extends "layout.html" %}
{% block title %}
    ì†Œì…œ í—ˆë¸Œ | CrossVibe
{% endblock title %}
{% block content %}
    <div class="container mt-4">
        <!-- í—¤ë” -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>ğŸ‘¥ ì†Œì…œ í—ˆë¸Œ</h2>
            <a href="{{ url_for('public.home') }}" class="btn btn-outline-secondary">â† í™ˆìœ¼ë¡œ</a>
        </div>
        <!-- ì‚¬ìš©ìëª… í™•ì¸ -->
        {% if not user.username %}
            <div class="alert alert-warning">
                <h5>âš ï¸ ì‚¬ìš©ìëª…ì´ í•„ìš”í•©ë‹ˆë‹¤</h5>
                <p>ì†Œì…œ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¨¼ì € ì‚¬ìš©ìëª…ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.</p>
                <a href="{{ url_for('public.set_username_page') }}"
                   class="btn btn-primary">ğŸ¯ ì‚¬ìš©ìëª… ì„¤ì •í•˜ê¸°</a>
            </div>
        {% else %}
            <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
            <ul class="nav nav-tabs mb-4" id="socialTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active"
                            id="add-friends-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#add-friends"
                            type="button"
                            role="tab">â• ì¹œêµ¬ ì¶”ê°€</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link position-relative"
                            id="received-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#received"
                            type="button"
                            role="tab">
                        ğŸ“¨ ë°›ì€ ì‹ ì²­
                        {% if pending_requests_count > 0 %}
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                {{ pending_requests_count }}
                            </span>
                        {% endif %}
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link"
                            id="friends-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#friends"
                            type="button"
                            role="tab">ğŸ‘« ë‚´ ì¹œêµ¬ ({{ friends|length }})</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link"
                            id="sent-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#sent"
                            type="button"
                            role="tab">ğŸ“¤ ë³´ë‚¸ ì‹ ì²­</button>
                </li>
            </ul>
            <!-- íƒ­ ì»¨í…ì¸  -->
            <div class="tab-content" id="socialTabsContent">
                <!-- ì¹œêµ¬ ì¶”ê°€ íƒ­ -->
                <div class="tab-pane fade show active" id="add-friends" role="tabpanel">
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">ğŸ” ì¹œêµ¬ ì°¾ê¸°</h5>
                                </div>
                                <div class="card-body">
                                    <form id="friendSearchForm">
                                        <div class="input-group mb-3">
                                            <input type="text"
                                                   class="form-control"
                                                   id="friendUsername"
                                                   placeholder="ì¹œêµ¬ì˜ ì‚¬ìš©ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                                                   maxlength="20">
                                            <button class="btn btn-success" type="submit">â• ì‹ ì²­ ë³´ë‚´ê¸°</button>
                                        </div>
                                    </form>
                                    <div class="alert alert-info">
                                        <small>
                                            <strong>ğŸ’¡ íŒ:</strong> ì •í™•í•œ ì‚¬ìš©ìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.
                                            ëŒ€ì†Œë¬¸ìë¥¼ êµ¬ë¶„í•©ë‹ˆë‹¤.
                                        </small>
                                    </div>
                                    <!-- ë‚´ ì‚¬ìš©ìëª… ì •ë³´ -->
                                    <div class="bg-light p-3 rounded">
                                        <strong>ë‚´ ì‚¬ìš©ìëª…:</strong>
                                        <code>{{ user.username }}</code>
                                        <br>
                                        <small class="text-muted">ì¹œêµ¬ë“¤ì—ê²Œ ì´ ì‚¬ìš©ìëª…ìœ¼ë¡œ ì•Œë ¤ì£¼ì„¸ìš”!</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- ë‚´ ì¹œêµ¬ íƒ­ -->
                <div class="tab-pane fade" id="friends" role="tabpanel">
                    {% if friends %}
                        <div class="row">
                            {% for friend in friends %}
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 class="card-title mb-1">{{ friend.display_name or friend.username }}</h6>
                                                    <small class="text-muted">
                                                        {% if friend.platform_connections %}
                                                            {% for conn in friend.platform_connections %}
                                                                {% if conn.platform == "spotify" %}ğŸµ Spotify{% endif %}
                                                                {% if conn.platform == "youtube" %}â–¶ï¸ YouTube{% endif %}
                                                                {% if not loop.last %},{% endif %}
                                                            {% endfor %}
                                                        {% else %}
                                                            ì—°ê²°ëœ í”Œë«í¼ ì—†ìŒ
                                                        {% endif %}
                                                    </small>
                                                </div>
                                                <div>
                                                    <button class="btn btn-primary btn-sm"
                                                            onclick="viewFriendProfile('{{ friend.id }}')">
                                                        ğŸ‘¤ í”„ë¡œí•„
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <!-- ì¹œêµ¬ í†µê³„ -->
                        <div class="mt-4 p-3 bg-light rounded">
                            <h6>ğŸ“Š ì¹œêµ¬ í†µê³„</h6>
                            <p class="mb-0">ì´ {{ friends|length }}ëª…ì˜ ì¹œêµ¬ì™€ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤!</p>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <div class="display-1">ğŸ‘¥</div>
                            <h4>ì•„ì§ ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤</h4>
                            <p class="text-muted">ì¹œêµ¬ë¥¼ ì¶”ê°€í•´ì„œ ìŒì•… ì·¨í–¥ì„ ê³µìœ í•´ë³´ì„¸ìš”!</p>
                            <button class="btn btn-primary"
                                    onclick="document.getElementById('add-friends-tab').click()">ì¹œêµ¬ ì¶”ê°€í•˜ê¸°</button>
                        </div>
                    {% endif %}
                </div>
                <!-- ë°›ì€ ì‹ ì²­ íƒ­ -->
                <div class="tab-pane fade" id="received" role="tabpanel">
                    {% if pending_requests %}
                        <div class="row">
                            {% for req in pending_requests %}
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 class="card-title mb-1">{{ req.requester.display_name or req.requester.username }}</h6>
                                                    <small class="text-muted">{{ req.created_at|kst }}</small>
                                                </div>
                                                <div>
                                                    <button class="btn btn-success btn-sm me-1"
                                                            onclick="respondToRequest({{ req.id }}, 'accept')">
                                                        âœ… ìˆ˜ë½
                                                    </button>
                                                    <button class="btn btn-danger btn-sm"
                                                            onclick="respondToRequest({{ req.id }}, 'reject')">
                                                        âŒ ê±°ì ˆ
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <div class="display-1">ğŸ“­</div>
                            <h4>ë°›ì€ ì¹œêµ¬ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤</h4>
                            <p class="text-muted">ìƒˆë¡œìš´ ì¹œêµ¬ë“¤ì´ ì—°ê²°ë˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”!</p>
                        </div>
                    {% endif %}
                </div>
                <!-- ë³´ë‚¸ ì‹ ì²­ íƒ­ -->
                <div class="tab-pane fade" id="sent" role="tabpanel">
                    {% if sent_requests %}
                        <div class="row">
                            {% for req in sent_requests %}
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 class="card-title mb-1">{{ req.receiver.display_name or req.receiver.username }}</h6>
                                                    <small class="text-muted">{{ req.created_at|kst }}ì— ì „ì†¡</small>
                                                </div>
                                                <div>
                                                    {% if req.status == "pending" %}
                                                        <span class="badge bg-warning me-1">â³ ëŒ€ê¸°ì¤‘</span>
                                                        <button class="btn btn-danger btn-sm" onclick="cancelRequest({{ req.id }})">ì·¨ì†Œ</button>
                                                    {% elif req.status == "accepted" %}
                                                        <span class="badge bg-success">âœ… ìˆ˜ë½ë¨</span>
                                                    {% elif req.status == "rejected" %}
                                                        <span class="badge bg-danger">âŒ ê±°ì ˆë¨</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <!-- ì‹ ì²­ í˜„í™© í†µê³„ -->
                        {% set pending_count = sent_requests | selectattr("status", "equalto", "pending") | list | length %}
                        {% set accepted_count = sent_requests | selectattr("status", "equalto", "accepted") | list | length %}
                        {% set rejected_count = sent_requests | selectattr("status", "equalto", "rejected") | list | length %}
                        <div class="mt-4 p-3 bg-light rounded">
                            <h6>ğŸ“Š ì‹ ì²­ í˜„í™©</h6>
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="badge bg-warning fs-6">â³ ëŒ€ê¸°: {{ pending_count }}</div>
                                </div>
                                <div class="col-4">
                                    <div class="badge bg-success fs-6">âœ… ìˆ˜ë½: {{ accepted_count }}</div>
                                </div>
                                <div class="col-4">
                                    <div class="badge bg-danger fs-6">âŒ ê±°ì ˆ: {{ rejected_count }}</div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <div class="display-1">ğŸ“¤</div>
                            <h4>ë³´ë‚¸ ì¹œêµ¬ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤</h4>
                            <p class="text-muted">ìƒˆë¡œìš´ ì¹œêµ¬ë“¤ì—ê²Œ ì‹ ì²­ì„ ë³´ë‚´ë³´ì„¸ìš”!</p>
                            <button class="btn btn-primary"
                                    onclick="document.getElementById('add-friends-tab').click()">ì¹œêµ¬ ì‹ ì²­ ë³´ë‚´ê¸°</button>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>
    <script>
// ì¹œêµ¬ ì‹ ì²­ ë³´ë‚´ê¸°
document.getElementById('friendSearchForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const username = document.getElementById('friendUsername').value.trim();
    if (!username) {
        alert('ì¹œêµ¬ì˜ ì‚¬ìš©ìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    try {
        const response = await fetch('/send-friend-request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: username })
        });

        const result = await response.json();
        
        if (response.ok) {
            alert('ì¹œêµ¬ ì‹ ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤!');
            document.getElementById('friendUsername').value = '';
            location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë³´ë‚¸ ì‹ ì²­ íƒ­ ì—…ë°ì´íŠ¸
        } else {
            alert('ì˜¤ë¥˜: ' + result.error);
        }
    } catch (error) {
        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
});

// ì¹œêµ¬ ì‹ ì²­ ì‘ë‹µ
async function respondToRequest(requestId, action) {
    const actionText = action === 'accept' ? 'ìˆ˜ë½' : 'ê±°ì ˆ';
    
    if (!confirm(`ì •ë§ë¡œ ì´ ì¹œêµ¬ ì‹ ì²­ì„ ${actionText}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }

    try {
        const response = await fetch(`/respond-friend-request/${requestId}/${action}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const result = await response.json();
        
        if (response.ok) {
            alert(result.message);
            location.reload();
        } else {
            alert('ì˜¤ë¥˜: ' + result.error);
        }
    } catch (error) {
        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ì¹œêµ¬ ì‹ ì²­ ì·¨ì†Œ
async function cancelRequest(requestId) {
    if (!confirm('ì •ë§ë¡œ ì´ ì¹œêµ¬ ì‹ ì²­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }

    try {
        const response = await fetch(`/cancel-friend-request/${requestId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const result = await response.json();
        
        if (response.ok) {
            alert(result.message);
            location.reload();
        } else {
            alert('ì˜¤ë¥˜: ' + result.error);
        }
    } catch (error) {
        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ì¹œêµ¬ í”„ë¡œí•„ ë³´ê¸° (í–¥í›„ êµ¬í˜„)
function viewFriendProfile(friendId) {
    alert(`ì¹œêµ¬ í”„ë¡œí•„ ë³´ê¸° ê¸°ëŠ¥ì€ ê³§ êµ¬í˜„ë  ì˜ˆì •ì…ë‹ˆë‹¤! (Friend ID: ${friendId})`);
    // í–¥í›„: window.location.href = `/friend/${friendId}/profile`;
}

// Enter í‚¤ë¡œ ì¹œêµ¬ ì‹ ì²­
document.getElementById('friendUsername').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        document.getElementById('friendSearchForm').dispatchEvent(new Event('submit'));
    }
});
    </script>
{% endblock content %}
