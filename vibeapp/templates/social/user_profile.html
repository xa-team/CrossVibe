{% extends "layout.html" %}
{% block title %}
    {{ profile_user.display_name or profile_user.username }} | CrossVibe
{% endblock title %}
{% block content %}
    <div class="container mt-4">
        <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
        <div class="mb-4">
            <button onclick="history.back()" class="btn btn-outline-secondary">â† ë’¤ë¡œê°€ê¸°</button>
        </div>
        <!-- í”„ë¡œí•„ í—¤ë” -->
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="card shadow-sm">
                    <div class="card-body text-center py-5">
                        <!-- í”„ë¡œí•„ ì•„ë°”íƒ€ -->
                        <div class="mb-4">
                            <div class="user-avatar user-avatar-lg">{{ (profile_user.display_name or profile_user.username)[0].upper() }}</div>
                        </div>
                        <!-- ì‚¬ìš©ì ì •ë³´ -->
                        <h2 class="mb-1">{{ profile_user.display_name or profile_user.username }}</h2>
                        <p class="text-muted mb-3">@{{ profile_user.username }}</p>
                        <!-- í”Œë«í¼ ì—°ê²° ì •ë³´ -->
                        <div class="mb-4">
                            {% if profile_user.platform_connections %}
                                <div class="user-platforms d-flex justify-content-center gap-3 flex-wrap"
                                     data-username="profile_user.username">
                                    {% for conn in profile_user.platform_connections %}
                                        <span class="platform-icon-mini" title="{{ conn.platform }}"></span>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <span class="text-muted">ì—°ê²°ëœ í”Œë«í¼ì´ ì—†ìŠµë‹ˆë‹¤</span>
                            {% endif %}
                        </div>
                        <!-- ê´€ê³„ ìƒíƒœì— ë”°ë¥¸ ì•¡ì…˜ ë²„íŠ¼ -->
                        <div class="mb-4">
                            {% if relationship_status == "friend" %}
                                <button class="btn btn-success btn-lg" disabled>ğŸ‘« ì¹œêµ¬</button>
                                <button class="btn btn-outline-primary ms-2"
                                        onclick="UserProfile.sendMessage()">ğŸ’¬ ë©”ì‹œì§€ (ì¤€ë¹„ì¤‘)</button>
                            {% elif relationship_status == "sent_request" %}
                                <button class="btn btn-warning btn-lg" disabled>â³ ì¹œêµ¬ ì‹ ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤</button>
                                <button class="btn btn-outline-danger ms-2"
                                        onclick="UserProfile.cancelFriendRequest({{ friend_request.id }})">ì·¨ì†Œ</button>
                            {% elif relationship_status == "received_request" %}
                                <button class="btn btn-info btn-lg" disabled>ğŸ“¨ ì¹œêµ¬ ì‹ ì²­ì„ ë°›ì•˜ìŠµë‹ˆë‹¤</button>
                                <div class="mt-2">
                                    <button class="btn btn-success"
                                            onclick="UserProfile.respondToRequest({{ friend_request.id }}, 'accept')">
                                        âœ… ìˆ˜ë½
                                    </button>
                                    <button class="btn btn-danger ms-2"
                                            onclick="UserProfile.respondToRequest({{ friend_request.id }}, 'reject')">
                                        âŒ ê±°ì ˆ
                                    </button>
                                </div>
                            {% else %}
                                <button class="btn btn-primary btn-lg"
                                        onclick="UserProfile.sendFriendRequest('{{ profile_user.username }}')">
                                    â• ì¹œêµ¬ ì‹ ì²­ ë³´ë‚´ê¸°
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- í†µê³„ ì •ë³´ -->
        <div class="row mt-4">
            <div class="col-md-8 mx-auto">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">ğŸ“Š í™œë™ ì •ë³´</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="h4 text-primary">{{ profile_user.get_friends() |length }}</div>
                                <div class="text-muted">ì¹œêµ¬</div>
                            </div>
                            <div class="col-4">
                                {% if profile_user.platform_connections %}
                                    <div class="user-platforms d-flex justify-content-center gap-3 flex-wrap"
                                         data-username="profile_user.username">
                                        {% for conn in profile_user.platform_connections %}
                                            <span class="platform-icon-mini" title="{{ conn.platform }}"></span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="text-muted">ì—°ê²°ëœ í”Œë«í¼</div>
                            </div>
                            <div class="col-4">
                                <div class="h4 text-info">
                                    {% set total_playlists = 0 %}
                                    {% for conn in profile_user.platform_connections %}
                                        {% set total_playlists = total_playlists + conn.playlists|length %}
                                    {% endfor %}
                                    {{ total_playlists }}
                                </div>
                                <div class="text-muted">í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ê³µí†µ ì¹œêµ¬ (ì¹œêµ¬ì¸ ê²½ìš°ì—ë§Œ í‘œì‹œ) -->
        {% if relationship_status == "friend" and mutual_friends %}
            <div class="row mt-4">
                <div class="col-md-8 mx-auto">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">ğŸ¤ ê³µí†µ ì¹œêµ¬ ({{ mutual_friends|length }}ëª…)</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% for friend in mutual_friends[:6] %}
                                    <div class="col-md-4 mb-3">
                                        <div class="d-flex align-items-center">
                                            <div class="user-avatar user-avatar-sm me-3">{{ (friend.display_name or friend.username)[0].upper() }}</div>
                                            <div>
                                                <div class="fw-bold small">{{ friend.display_name or friend.username }}</div>
                                                <div class="text-muted small">@{{ friend.username }}</div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            {% if mutual_friends|length > 6 %}
                                <div class="text-center mt-3">
                                    <small class="text-muted">ê·¸ ì™¸ {{ mutual_friends|length - 6 }}ëª…ì˜ ê³µí†µ ì¹œêµ¬ê°€ ë” ìˆìŠµë‹ˆë‹¤.</small>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        <!-- ìŒì•… ì·¨í–¥ (ì¹œêµ¬ì¸ ê²½ìš°ì—ë§Œ í‘œì‹œ) -->
        {% if relationship_status == "friend" %}
            <div class="row mt-4">
                <div class="col-md-8 mx-auto">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">ğŸµ {{ profile_user.display_name or profile_user.username }}ë‹˜ì˜ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% for playlist in playlists[:6] %}
                                    <div class="col-md-6 mb-3">
                                        <a href="{{ url_for('playlist.playlist_detail', playlist_id=playlist.id) }}"
                                           class="text-decoration-none text-dark">
                                            <div class="card border-0 bg-light card-hover h-100">
                                                <div class="card-body py-2">
                                                    <div class="d-flex align-items-center">
                                                        <span class="platform-icon-playlist me-3" title="{{ playlist.platform }}"></span>
                                                        <div class="flex-grow-1">
                                                            <div class="fw-bold small">{{ playlist.name }}</div>
                                                            <div class="text-muted small">{{ playlist.platform|title }}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </a>
                                    </div>
                                {% endfor %}
                            </div>
                            {% if user_playlists|length > 6 %}
                                <div class="text-center mt-3">
                                    <small class="text-muted">ê·¸ ì™¸ {{ user_playlists|length - 6 }}ê°œì˜ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ê°€ ë” ìˆìŠµë‹ˆë‹¤.</small>
                                </div>
                            {% endif %}
                            <div class="text-center text-muted py-4">
                                <div class="display-4">ğŸµ</div>
                                <p class="mb-0">ê³µê°œëœ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <div class="row mt-4">
            <div class="col-md-8 mx-auto">
                <div class="card border-secondary">
                    <div class="card-body text-center py-5">
                        <div class="display-4 mb-3">ğŸ”’</div>
                        <h5>ìŒì•… ì •ë³´ëŠ” ì¹œêµ¬ë§Œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤</h5>
                        <p class="text-muted">{{ profile_user.display_name or profile_user.username }}ë‹˜ê³¼ ì¹œêµ¬ê°€ ë˜ì–´ ìŒì•… ì·¨í–¥ì„ ê³µìœ í•´ë³´ì„¸ìš”!</p>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>
{% block scripts %}
    <script src="{{ url_for('static', filename='js/core/api.js') }}"></script>
    <script src="{{ url_for('static', filename='js/core/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/friends.js') }}"></script>
    <script src="{{ url_for('static', filename='js/pages/social.js') }}"></script>
    <script>
            document.addEventListener('DOMContentLoaded', function() {
                document.querySelectorAll('.user-platforms').forEach(container => {
                    const icons = container.querySelectorAll('.platform-icon-mini');
                    icons.forEach(icon => {
                        const platform = icon.getAttribute('title');
                        icon.innerHTML = CrossVibeUtils.getPlatformIcon(platform, {size: 24});
                    });
                });
                document.querySelectorAll('.platform-icon-playlist').forEach(icon => {
                    const platform = icon.getAttribute('title');
                    icon.innerHTML = CrossVibeUtils.getPlatformIcon(platform, {size: 24});
                });
            });
    </script>
{% endblock scripts %}
{% endblock content %}
