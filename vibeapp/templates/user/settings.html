<!-- vibeapp/public/templates/settings.html -->
{% extends "layout.html" %}
{% block title %}
    ì„¤ì • | CrossVibe
{% endblock title %}
{% block content %}
    <div class="container mt-4">
        <!-- í—¤ë” -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>âš™ï¸ ì„¤ì •</h2>
            <a href="{{ url_for('public.home') }}" class="btn btn-outline-secondary">â† í™ˆìœ¼ë¡œ</a>
        </div>
        <div class="row">
            <!-- ê³„ì • ì„¤ì • -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">ğŸ‘¤ ê³„ì • ì •ë³´</h5>
                    </div>
                    <div class="card-body">
                        <!-- ì‚¬ìš©ìëª… ì„¤ì • -->
                        <div class="mb-3">
                            <label class="form-label">ì‚¬ìš©ìëª…</label>
                            <div class="input-group">
                                <input type="text"
                                       class="form-control"
                                       id="usernameInput"
                                       value="{{ user.username or '' }}"
                                       placeholder="ì‚¬ìš©ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                                       maxlength="20">
                                <button class="btn btn-outline-secondary" id="updateUsernameBtn">ë³€ê²½</button>
                            </div>
                            <div class="form-text">ì˜ë¬¸, ìˆ«ì, ì–¸ë”ìŠ¤ì½”ì–´(_)ë§Œ ì‚¬ìš© ê°€ëŠ¥ (3-20ì)</div>
                        </div>
                        <!-- í‘œì‹œëª… -->
                        <div class="mb-3">
                            <label class="form-label">í‘œì‹œëª…</label>
                            <input type="text"
                                   class="form-control"
                                   value="{{ user.display_name or '' }}"
                                   readonly>
                            <div class="form-text">í”Œë«í¼ì—ì„œ ê°€ì ¸ì˜¨ ì´ë¦„ì…ë‹ˆë‹¤</div>
                        </div>
                        <!-- ê³„ì • ê¶Œí•œ -->
                        <div class="mb-3">
                            <label class="form-label">ê³„ì • ê¶Œí•œ</label>
                            <div class="form-control-plaintext">
                                {% if user.is_admin %}
                                    ğŸ›¡ï¸ ê´€ë¦¬ì
                                {% else %}
                                    ğŸ‘¤ ì¼ë°˜ ì‚¬ìš©ì
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- í”Œë«í¼ ì—°ê²° -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">ğŸ”— í”Œë«í¼ ì—°ê²°</h5>
                    </div>
                    <div class="card-body">
                        {% if user.platform_connections %}
                            {% for conn in user.platform_connections %}
                                <div class="d-flex justify-content-between align-items-center mb-3 p-2 border rounded">
                                    <div>
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="platform-icon-settings" title="{{ conn.platform }}"></span>
                                            <strong>{{ conn.platform|title }}</strong>
                                        </div>
                                        <small class="text-muted ms-1">í† í° ë§Œë£Œ: {{ conn.token.expire_at|kst if conn.token.expire_at else "ì—†ìŒ" }}</small>
                                    </div>
                                    <div>
                                        <span class="badge bg-success">ì—°ê²°ë¨</span>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center text-muted">
                                <p>ì—°ê²°ëœ í”Œë«í¼ì´ ì—†ìŠµë‹ˆë‹¤</p>
                            </div>
                        {% endif %}
                        <!-- ìƒˆ í”Œë«í¼ ì—°ê²° -->
                        <div class="mt-3">
                            <h6>ìƒˆ í”Œë«í¼ ì—°ê²°</h6>
                            <div class="d-grid gap-2">
                                {% set available_platforms = ["spotify", "youtube"] %}
                                {% set connected_platforms = user.platform_connections|map(attribute='platform')|list %}
                                {% for platform in available_platforms %}
                                    {% if platform not in connected_platforms %}
                                        <a href="{{ url_for('public.login_platform', platform=platform) }}"
                                           class="btn btn-outline-secondary btn-sm d-flex align-items-center justify-content-center gap-2 platform-connect-btn"
                                           data-platform="{{ platform }}">
                                            <span class="btn-icon"></span> {{ platform|title }} ì—°ê²°
                                        </a>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- í†µê³„ ì •ë³´ -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">ğŸ“Š ë‚´ í™œë™ í†µê³„</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="h4 text-primary">{{ user.get_friends() |length }}</div>
                                <div class="text-muted">ì¹œêµ¬</div>
                            </div>
                            <div class="col-md-3">
                                <div class="h4 text-success">{{ user.platform_connections|length }}</div>
                                <div class="text-muted">ì—°ê²°ëœ í”Œë«í¼</div>
                            </div>
                            <div class="col-md-3">
                                <div class="h4 text-warning">{{ user.get_pending_friend_requests_count() }}</div>
                                <div class="text-muted">ë°›ì€ ì‹ ì²­</div>
                            </div>
                            <div class="col-md-3">
                                <div class="h4 text-info">
                                    {% set total_playlists = 0 %}
                                    {% for conn in user.platform_connections %}
                                        {% set total_playlists = total_playlists + conn.playlists|length %}
                                    {% endfor %}
                                    {{ total_playlists }}
                                </div>
                                <div class="text-muted">í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ìœ„í—˜í•œ ì‘ì—… -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-danger">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">âš ï¸ ìœ„í—˜í•œ ì‘ì—…</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">ì´ ì‘ì—…ë“¤ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹ ì¤‘í•˜ê²Œ ê²°ì •í•´ì£¼ì„¸ìš”.</p>
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-outline-warning btn-sm" id="clearDataBtn">ğŸ—‘ï¸ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”</button>
                            <button class="btn btn-outline-danger btn-sm" id="deleteAccountBtn">ğŸ’€ ê³„ì • ì‚­ì œ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% block scripts %}
        <script src="{{ url_for('static', filename='js/core/api.js') }}"></script>
        <script src="{{ url_for('static', filename='js/core/utils.js') }}"></script>
        <script src="{{ url_for('static', filename='js/modules/notifications.js') }}"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // 1. í”Œë«í¼ ì•„ì´ì½˜ ë Œë”ë§ (ì—°ê²°ëœ í”Œë«í¼)
                document.querySelectorAll('.platform-icon-settings').forEach(icons => {
                    const platform = icons.getAttribute('title');
                    icons.innerHTML = CrossVibeUtils.getPlatformIcon(platform, {size: 24});
                });

                // 2. í”Œë«í¼ ì•„ì´ì½˜ ë Œë”ë§ (ì—°ê²° ë²„íŠ¼)
                document.querySelectorAll('.platform-connect-btn').forEach(btn => {
                    const platform = btn.dataset.platform;
                    const iconSpan = btn.querySelector('.btn-icon');
                    if(iconSpan) {
                        iconSpan.innerHTML = CrossVibeUtils.getPlatformIcon(platform, {size: 18});
                    }
                });

                // 3. ì‚¬ìš©ìëª… ë³€ê²½ ì´ë²¤íŠ¸ ì—°ê²°
                const usernameInput = document.getElementById('usernameInput');
                const updateBtn = document.getElementById('updateUsernameBtn');

                if(updateBtn) {
                    updateBtn.addEventListener('click', handleUpdateUsername);
                }

                if(usernameInput) {
                    usernameInput.addEventListener('keypress', function(e) {
                        if(e.key === 'Enter') handleUpdateUsername();
                    });
                }

                // 4. ìœ„í—˜í•œ ì‘ì—… ì´ë²¤íŠ¸ ì—°ê²°
                const clearDataBtn = document.getElementById('clearDataBtn');
                if(clearDataBtn) {
                    clearDataBtn.addEventListener('click', function() {
                        NotificationManager.confirm(
                            'ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
                            () => {
                                NotificationManager.info('ì´ ê¸°ëŠ¥ì€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (Backend Pending)');
                            }
                        );
                    });
                }

                const deleteAccountBtn = document.getElementById('deleteAccountBtn');
                if(deleteAccountBtn) {
                    deleteAccountBtn.addEventListener('click', function() {
                        const confirmText = prompt('ê³„ì •ì„ ì‚­ì œí•˜ë ¤ë©´ "DELETE"ë¥¼ ì…ë ¥í•˜ì„¸ìš”: ');
                        if(confirmText === 'DELETE') {
                            NotificationManager.info('ì´ ê¸°ëŠ¥ì€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (Backend Pending)');
                        }
                    });
                }
            });

            // ì‚¬ìš©ìëª… ì—…ë°ì´íŠ¸
            async function handleUpdateUsername() {
                const usernameInput = document.getElementById('usernameInput');
                const updateBtn = document.getElementById('updateUsernameBtn');
                const username = usernameInput.value.trim();
    
                // 1. ìœ íš¨ì„± ê²€ì‚¬
                const validation = CrossVibeUtils.validateUsername(username);
                if(!validation.valid) {
                    NotificationManager.warning(validation.msg || validation.message);
                    return;
                }

                // 2. ë¡œë”© ìƒíƒœ ì ìš©
                CrossVibeUtils.setLoading(updateBtn, true);

                try {
                    // 3. API í˜¸ì¶œ
                    const result = await CrossVibeAPI.updateUsername(username);

                    if(result.success) {
                        NotificationManager.success("ì‚¬ìš©ìëª…ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        NotificationManager.error(result.error || "ì‚¬ìš©ìëª… ë³€ê²½ ì‹¤íŒ¨");
                        CrossVibeUtils.setLoading(updateBtn, false, "ë³€ê²½");
                    }
                } catch (error) {
                    NotificationManager.error(CrossVibeUtils.handleError(error, "ì‚¬ìš©ìëª… ë³€ê²½"));
                    CrossVibeUtils.setLoading(updateBtn, false, "ë³€ê²½");
                }
            }
        </script>
    {% endblock scripts %}
{% endblock content %}
