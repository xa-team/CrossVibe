<!-- vibeapp/public/templates/settings.html -->
{% extends "layout.html" %}
{% block title %}
    ì„¤ì • | CrossVibe
{% endblock title %}
{% block content %}
    <div class="container mt-4">
        <!-- í—¤ë” -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>âš™ï¸ ì„¤ì •</h2>
            <a href="{{ url_for('public.home') }}" class="btn btn-outline-secondary">â† í™ˆìœ¼ë¡œ</a>
        </div>
        <div class="row">
            <!-- ê³„ì • ì„¤ì • -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">ğŸ‘¤ ê³„ì • ì •ë³´</h5>
                    </div>
                    <div class="card-body">
                        <!-- ì‚¬ìš©ìëª… ì„¤ì • -->
                        <div class="mb-3">
                            <label class="form-label">ì‚¬ìš©ìëª…</label>
                            <div class="input-group">
                                <input type="text"
                                       class="form-control"
                                       id="usernameInput"
                                       value="{{ user.username or '' }}"
                                       placeholder="ì‚¬ìš©ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                                       maxlength="20">
                                <button class="btn btn-outline-secondary" onclick="updateUsername()">ë³€ê²½</button>
                            </div>
                            <div class="form-text">ì˜ë¬¸, ìˆ«ì, ì–¸ë”ìŠ¤ì½”ì–´(_)ë§Œ ì‚¬ìš© ê°€ëŠ¥ (3-20ì)</div>
                        </div>
                        <!-- í‘œì‹œëª… -->
                        <div class="mb-3">
                            <label class="form-label">í‘œì‹œëª…</label>
                            <input type="text"
                                   class="form-control"
                                   value="{{ user.display_name or '' }}"
                                   readonly>
                            <div class="form-text">í”Œë«í¼ì—ì„œ ê°€ì ¸ì˜¨ ì´ë¦„ì…ë‹ˆë‹¤</div>
                        </div>
                        <!-- ê³„ì • ê¶Œí•œ -->
                        <div class="mb-3">
                            <label class="form-label">ê³„ì • ê¶Œí•œ</label>
                            <div class="form-control-plaintext">
                                {% if user.is_admin %}
                                    ğŸ›¡ï¸ ê´€ë¦¬ì
                                {% else %}
                                    ğŸ‘¤ ì¼ë°˜ ì‚¬ìš©ì
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- í”Œë«í¼ ì—°ê²° -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">ğŸ”— í”Œë«í¼ ì—°ê²°</h5>
                    </div>
                    <div class="card-body">
                        {% if user.platform_connections %}
                            {% for conn in user.platform_connections %}
                                <div class="d-flex justify-content-between align-items-center mb-3 p-2 border rounded">
                                    <div>
                                        {% if conn.platform == "spotify" %}
                                            <img src="https://cdn-icons-png.flaticon.com/24/174/174872.png"
                                                 alt="Spotify"
                                                 width="24"
                                                 height="24">
                                            <strong>Spotify</strong>
                                        {% elif conn.platform == "youtube" %}
                                            <img src="https://cdn-icons-png.flaticon.com/24/1384/1384060.png"
                                                 alt="YouTube"
                                                 width="24"
                                                 height="24">
                                            <strong>YouTube Music</strong>
                                        {% else %}
                                            <strong>{{ conn.platform|title }}</strong>
                                        {% endif %}
                                        <br>
                                        <small class="text-muted">í† í° ë§Œë£Œ: {{ conn.token.expire_at|kst if conn.token.expire_at else "ì—†ìŒ" }}</small>
                                    </div>
                                    <div>
                                        <span class="badge bg-success">ì—°ê²°ë¨</span>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center text-muted">
                                <p>ì—°ê²°ëœ í”Œë«í¼ì´ ì—†ìŠµë‹ˆë‹¤</p>
                            </div>
                        {% endif %}
                        <!-- ìƒˆ í”Œë«í¼ ì—°ê²° -->
                        <div class="mt-3">
                            <h6>ìƒˆ í”Œë«í¼ ì—°ê²°</h6>
                            <div class="d-grid gap-2">
                                {% set available_platforms = ["spotify", "youtube"] %}
                                {% set connected_platforms = user.platform_connections|map(attribute='platform')|list %}
                                {% for platform in available_platforms %}
                                    {% if platform not in connected_platforms %}
                                        {% if platform == "spotify" %}
                                            <a href="{{ url_for('public.login_platform', platform='spotify') }}"
                                               class="btn btn-outline-success btn-sm">ğŸµ Spotify ì—°ê²°</a>
                                        {% elif platform == "youtube" %}
                                            <a href="{{ url_for('public.login_platform', platform='youtube') }}"
                                               class="btn btn-outline-danger btn-sm">â–¶ï¸ YouTube Music ì—°ê²°</a>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- í†µê³„ ì •ë³´ -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">ğŸ“Š ë‚´ í™œë™ í†µê³„</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="h4 text-primary">{{ user.get_friends() |length }}</div>
                                <div class="text-muted">ì¹œêµ¬</div>
                            </div>
                            <div class="col-md-3">
                                <div class="h4 text-success">{{ user.platform_connections|length }}</div>
                                <div class="text-muted">ì—°ê²°ëœ í”Œë«í¼</div>
                            </div>
                            <div class="col-md-3">
                                <div class="h4 text-warning">{{ user.get_pending_friend_requests_count() }}</div>
                                <div class="text-muted">ë°›ì€ ì‹ ì²­</div>
                            </div>
                            <div class="col-md-3">
                                <div class="h4 text-info">
                                    {% set total_playlists = 0 %}
                                    {% for conn in user.platform_connections %}
                                        {% set total_playlists = total_playlists + conn.playlists|length %}
                                    {% endfor %}
                                    {{ total_playlists }}
                                </div>
                                <div class="text-muted">í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ìœ„í—˜í•œ ì‘ì—… -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-danger">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">âš ï¸ ìœ„í—˜í•œ ì‘ì—…</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">ì´ ì‘ì—…ë“¤ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹ ì¤‘í•˜ê²Œ ê²°ì •í•´ì£¼ì„¸ìš”.</p>
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-outline-warning btn-sm" onclick="clearAllData()">ğŸ—‘ï¸ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”</button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteAccount()">ğŸ’€ ê³„ì • ì‚­ì œ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
// ì‚¬ìš©ìëª… ì—…ë°ì´íŠ¸
async function updateUsername() {
    const username = document.getElementById('usernameInput').value.trim();
    
    if (!username) {
        alert('ì‚¬ìš©ìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    // ìœ íš¨ì„± ê²€ì‚¬
    if (!/^[a-zA-Z0-9_]{3,20}$/.test(username)) {
        alert('ì‚¬ìš©ìëª…ì€ ì˜ë¬¸, ìˆ«ì, ì–¸ë”ìŠ¤ì½”ì–´ë§Œ ì‚¬ìš©í•˜ì—¬ 3-20ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    try {
        const response = await fetch('/update-username', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: username })
        });

        const result = await response.json();
        
        if (response.ok) {
            alert(result.message);
            location.reload();
        } else {
            alert('ì˜¤ë¥˜: ' + result.error);
        }
    } catch (error) {
        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™” (í–¥í›„ êµ¬í˜„)
function clearAllData() {
    if (confirm('ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        alert('ì´ ê¸°ëŠ¥ì€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    }
}

// ê³„ì • ì‚­ì œ (í–¥í›„ êµ¬í˜„)
function deleteAccount() {
    const confirmText = prompt('ê³„ì •ì„ ì‚­ì œí•˜ë ¤ë©´ "DELETE"ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
    if (confirmText === 'DELETE') {
        alert('ì´ ê¸°ëŠ¥ì€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    }
}

// Enter í‚¤ë¡œ ì‚¬ìš©ìëª… ì—…ë°ì´íŠ¸
document.getElementById('usernameInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        updateUsername();
    }
});
    </script>
{% endblock content %}
