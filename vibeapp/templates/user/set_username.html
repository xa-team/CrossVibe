<!-- vibeapp/public/templates/set_username.html -->
{% extends "layout.html" %}
{% block title %}
    ì‚¬ìš©ìëª… ì„¤ì • | CrossVibe
{% endblock title %}
{% block content %}
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white text-center">
                        <h4>ğŸ‘¤ ì‚¬ìš©ìëª… ì„¤ì •</h4>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <h6>ğŸ¯ ì‚¬ìš©ìëª…ì´ í•„ìš”í•œ ì´ìœ </h6>
                            <p class="mb-0">ì¹œêµ¬ë“¤ì´ ë‹¹ì‹ ì„ ì‰½ê²Œ ì°¾ì„ ìˆ˜ ìˆë„ë¡ ê³ ìœ í•œ ì‚¬ìš©ìëª…ì„ ì„¤ì •í•´ì£¼ì„¸ìš”!</p>
                        </div>
                        <form id="usernameForm">
                            <div class="mb-3">
                                <label for="username" class="form-label">ì‚¬ìš©ìëª…</label>
                                <input type="text"
                                       class="form-control"
                                       id="username"
                                       value="{{ user.username or '' }}"
                                       placeholder="ì˜ˆ: music_lover123"
                                       maxlength="20">
                                <div class="form-text">ì˜ë¬¸, ìˆ«ì, ì–¸ë”ìŠ¤ì½”ì–´(_)ë§Œ ì‚¬ìš© ê°€ëŠ¥ (3-20ì)</div>
                            </div>
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">
                                    {% if user.username %}
                                        âœï¸ ì‚¬ìš©ìëª… ë³€ê²½
                                    {% else %}
                                        âœ… ì‚¬ìš©ìëª… ì„¤ì •
                                    {% endif %}
                                </button>
                            </div>
                        </form>
                        <div class="mt-4 p-3 bg-light rounded">
                            <h6>ğŸ“ ì‚¬ìš©ìëª… ê·œì¹™</h6>
                            <ul class="mb-0 small">
                                <li>3ì ì´ìƒ 20ì ì´í•˜</li>
                                <li>ì˜ë¬¸ì, ìˆ«ì, ì–¸ë”ìŠ¤ì½”ì–´(_)ë§Œ ì‚¬ìš© ê°€ëŠ¥</li>
                                <li>ë‹¤ë¥¸ ì‚¬ìš©ìì™€ ì¤‘ë³µë  ìˆ˜ ì—†ìŒ</li>
                                <li>ë‚˜ì¤‘ì— ì–¸ì œë“ ì§€ ë³€ê²½ ê°€ëŠ¥</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% block scripts %}
        <script src="{{url_for('static', filename='js/core/api.js')}}"></script>
        <script src="{{url_for('static', filename='js/core/utils.js')}}"></script>
        <script src="{{url_for('static', filename='js/modules/notifications.js')}}"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const form = document.getElementById('usernameForm');
                const usernameInput = document.getElementById('username');
                const submitBtn = document.getElementById('submitBtn');

                usernameInput.addEventListener('input', function(e) {
                    const username = e.target.value;

                    if(!username) {
                        e.target.setCustomValidity('');
                        return;
                    }

                    const check = CrossVibeUtils.validateUsername(username);

                    if(!check.valid) {
                        e.target.setCustomValidity(check.message);
                    } else {
                        e.target.setCustomValidity('');
                    }
                    
                    e.target.reportValidity();
                });

                form.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    const username = usernameInput.value.trim();

                    const validation = CrossVibeUtils.validateUsername(username);
                    if(!validation.valid) {
                        NotificationManager.warning(validation.message);
                        usernameInput.focus();
                        return;
                    }

                    CrossVibeUtils.setLoading(submitBtn, true);

                    try {
                        const result = await CrossVibeAPI.updateUsername(username);

                        if(result.success) {
                            NotificationManager.success(result.data.message || "ì‚¬ìš©ìëª…ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");

                            setTimeout(() => {
                                window.location.href = "{{ url_for('public.home') }}";
                            }, 1000);
                        } else {
                            NotificationManager.error(result.error || "ì‚¬ìš©ìëª… ì„¤ì • ì‹¤íŒ¨");
                        }
                    } catch (error) {
                        NotificationManager.error(CrossVibeUtils.handleError(error, 'ì‚¬ìš©ìëª… ì„¤ì •'));
                    } finally {
                        CrossVibeUtils.setLoading(submitBtn, false);
                    }
                })
            })
        </script>
    {% endblock scripts %}
{% endblock content %}
